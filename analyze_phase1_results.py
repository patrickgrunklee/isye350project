"""
PHASE 1 RESULTS ANALYSIS
========================

Interprets and visualizes the packing configurations generated by Phase 1
"""

import pandas as pd
import numpy as np
from pathlib import Path
import sys

if sys.platform == 'win32':
    sys.stdout.reconfigure(encoding='utf-8')

PHASE1_DIR = Path(r"C:\Users\patri\OneDrive - UW-Madison\ISYE 350\Model\results\Phase1_SetPacking")
DATA_DIR = Path(r"C:\Users\patri\OneDrive - UW-Madison\ISYE 350\Model\Model Data")

print("="*100)
print("PHASE 1 SET PACKING RESULTS - DETAILED ANALYSIS")
print("="*100)

# Load Phase 1 results
configs_df = pd.read_csv(PHASE1_DIR / "packing_configurations.csv")
shelving_count_df = pd.read_csv(DATA_DIR / "Shelving Count.csv")

print(f"\n[1] OVERVIEW")
print(f"  Total configurations generated: {configs_df['Config_ID'].nunique()}")
print(f"  Total packing records: {len(configs_df)}")
print(f"  Facilities: {configs_df['Facility'].nunique()}")
print(f"  Storage types: {configs_df['Storage_Type'].nunique()}")

# Configurations by facility and storage type
print(f"\n[2] CONFIGURATIONS BY FACILITY AND STORAGE TYPE")
print(f"  {'Facility':<15} {'Storage Type':<15} {'Configurations':<15} {'Avg SKUs per Config':<20}")
print(f"  {'-'*70}")

for (fac, st), group in configs_df.groupby(['Facility', 'Storage_Type']):
    num_configs = group['Config_ID'].nunique()
    avg_skus = group.groupby('Config_ID').size().mean()
    print(f"  {fac:<15} {st:<15} {num_configs:<15} {avg_skus:<20.1f}")

# Detailed configuration analysis
print(f"\n[3] DETAILED CONFIGURATION ANALYSIS")
print(f"\n{'='*100}")

# Group by Config_ID
for config_id in sorted(configs_df['Config_ID'].unique()):
    config_data = configs_df[configs_df['Config_ID'] == config_id]

    fac = config_data.iloc[0]['Facility']
    st = config_data.iloc[0]['Storage_Type']

    # Calculate totals
    total_packages = config_data['Packages_per_Shelf'].sum()
    total_volume = config_data['Total_Volume'].sum()
    total_weight = config_data['Total_Weight'].sum()

    # Get shelf capacity for this (facility, storage_type)
    shelf_row = shelving_count_df[
        (shelving_count_df['Facility'] == fac) &
        (shelving_count_df['Shelving Type'].str.contains(st, case=False, na=False))
    ]

    if len(shelf_row) > 0:
        weight_cap = float(shelf_row.iloc[0]['Weight Max / Shelf'])
        weight_util = (total_weight / weight_cap * 100) if weight_cap > 0 else 0
    else:
        weight_cap = 0
        weight_util = 0

    print(f"\nConfiguration {config_id}: {fac} - {st}")
    print(f"  {'-'*90}")
    print(f"  {'SKU':<10} {'Packages':<12} {'Volume (cu ft)':<18} {'Weight (lbs)':<18} {'Units Total':<15}")
    print(f"  {'-'*90}")

    for _, row in config_data.iterrows():
        sku = row['SKU']
        packages = int(row['Packages_per_Shelf'])
        vol = row['Total_Volume']
        weight = row['Total_Weight']
        units = packages * int(row['Units_per_Package'])

        print(f"  {sku:<10} {packages:>8,}        {vol:>12.3f}        {weight:>12.1f}        {units:>10,}")

    print(f"  {'-'*90}")
    print(f"  {'TOTAL':<10} {total_packages:>8,}        {total_volume:>12.3f}        {total_weight:>12.1f}")

    if weight_cap > 0:
        print(f"\n  Shelf capacity:    {weight_cap:>10.1f} lbs")
        print(f"  Weight utilization: {weight_util:>9.1f}%")

    if config_id >= 10:
        print(f"\n  ... (showing first 10 configurations, {configs_df['Config_ID'].nunique() - 10} more available)")
        break

# Best configurations by utilization
print(f"\n{'='*100}")
print(f"[4] TOP 10 CONFIGURATIONS BY WEIGHT UTILIZATION")
print(f"{'='*100}")

# Calculate utilization for each config
config_utilization = []
for config_id in sorted(configs_df['Config_ID'].unique()):
    config_data = configs_df[configs_df['Config_ID'] == config_id]

    fac = config_data.iloc[0]['Facility']
    st = config_data.iloc[0]['Storage_Type']
    total_weight = config_data['Total_Weight'].sum()
    num_skus = len(config_data)

    shelf_row = shelving_count_df[
        (shelving_count_df['Facility'] == fac) &
        (shelving_count_df['Shelving Type'].str.contains(st, case=False, na=False))
    ]

    if len(shelf_row) > 0:
        weight_cap = float(shelf_row.iloc[0]['Weight Max / Shelf'])
        weight_util = (total_weight / weight_cap * 100) if weight_cap > 0 else 0
    else:
        weight_util = 0

    config_utilization.append({
        'Config_ID': config_id,
        'Facility': fac,
        'Storage_Type': st,
        'Total_Weight': total_weight,
        'Weight_Cap': weight_cap,
        'Utilization_%': weight_util,
        'Num_SKUs': num_skus
    })

util_df = pd.DataFrame(config_utilization).sort_values('Utilization_%', ascending=False)

print(f"\n  {'Rank':<6} {'Config':<8} {'Facility':<15} {'Storage':<12} {'Weight (lbs)':<15} {'Utilization':<12} {'SKUs':<6}")
print(f"  {'-'*80}")

for rank, (_, row) in enumerate(util_df.head(10).iterrows(), 1):
    print(f"  {rank:<6} {int(row['Config_ID']):<8} {row['Facility']:<15} {row['Storage_Type']:<12} {row['Total_Weight']:>10.1f}     {row['Utilization_%']:>6.1f}%      {int(row['Num_SKUs']):<6}")

# Worst configurations (for comparison)
print(f"\n{'='*100}")
print(f"[5] BOTTOM 5 CONFIGURATIONS BY WEIGHT UTILIZATION")
print(f"{'='*100}")

print(f"\n  {'Rank':<6} {'Config':<8} {'Facility':<15} {'Storage':<12} {'Weight (lbs)':<15} {'Utilization':<12} {'SKUs':<6}")
print(f"  {'-'*80}")

for rank, (_, row) in enumerate(util_df.tail(5).iterrows(), 1):
    print(f"  {rank:<6} {int(row['Config_ID']):<8} {row['Facility']:<15} {row['Storage_Type']:<12} {row['Total_Weight']:>10.1f}     {row['Utilization_%']:>6.1f}%      {int(row['Num_SKUs']):<6}")

# SKU frequency analysis
print(f"\n{'='*100}")
print(f"[6] SKU USAGE ACROSS CONFIGURATIONS")
print(f"{'='*100}")

sku_freq = configs_df.groupby('SKU').agg({
    'Config_ID': 'count',
    'Packages_per_Shelf': 'mean',
    'Total_Weight': 'sum'
}).rename(columns={'Config_ID': 'Times_Used', 'Packages_per_Shelf': 'Avg_Packages'})

sku_freq = sku_freq.sort_values('Times_Used', ascending=False)

print(f"\n  {'SKU':<10} {'Used in Configs':<20} {'Avg Packages/Shelf':<25} {'Total Weight (all configs)':<25}")
print(f"  {'-'*80}")

for sku, row in sku_freq.iterrows():
    print(f"  {sku:<10} {int(row['Times_Used']):<20} {row['Avg_Packages']:>18.1f}       {row['Total_Weight']:>18.1f}")

# Configuration diversity by (facility, storage_type)
print(f"\n{'='*100}")
print(f"[7] CONFIGURATION DIVERSITY")
print(f"{'='*100}")

print(f"\n  How many different SKUs appear in configs for each (facility, storage_type)?")
print(f"  {'Facility':<15} {'Storage Type':<15} {'Unique SKUs':<15} {'Total Configs':<15}")
print(f"  {'-'*70}")

for (fac, st), group in configs_df.groupby(['Facility', 'Storage_Type']):
    unique_skus = group['SKU'].nunique()
    num_configs = group['Config_ID'].nunique()
    print(f"  {fac:<15} {st:<15} {unique_skus:<15} {num_configs:<15}")

# Summary statistics
print(f"\n{'='*100}")
print(f"[8] SUMMARY STATISTICS")
print(f"{'='*100}")

avg_util = util_df['Utilization_%'].mean()
max_util = util_df['Utilization_%'].max()
min_util = util_df['Utilization_%'].min()

avg_skus = util_df['Num_SKUs'].mean()
max_skus = util_df['Num_SKUs'].max()
min_skus = util_df['Num_SKUs'].min()

print(f"\n  Weight Utilization:")
print(f"    Average: {avg_util:>6.1f}%")
print(f"    Maximum: {max_util:>6.1f}%")
print(f"    Minimum: {min_util:>6.1f}%")

print(f"\n  SKUs per Configuration:")
print(f"    Average: {avg_skus:>6.1f}")
print(f"    Maximum: {max_skus:>6.0f}")
print(f"    Minimum: {min_skus:>6.0f}")

print(f"\n{'='*100}")
print(f"ANALYSIS COMPLETE")
print(f"{'='*100}")

print(f"\nKEY INSIGHTS:")
print(f"  1. Generated {configs_df['Config_ID'].nunique()} discrete packing configurations")
print(f"  2. Average weight utilization: {avg_util:.1f}%")
print(f"  3. Most-used SKU: {sku_freq.index[0]} (appears in {int(sku_freq.iloc[0]['Times_Used'])} configs)")
print(f"  4. Best configuration: Config {int(util_df.iloc[0]['Config_ID'])} ({util_df.iloc[0]['Utilization_%']:.1f}% utilization)")

print(f"\nNext step: Use these {configs_df['Config_ID'].nunique()} configurations in Phase 2 to optimize")
print(f"           which configs to deploy and how many shelves of each config to use")
